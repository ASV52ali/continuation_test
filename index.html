<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>FaceID Bale Sender</title>
<style>
body {
    font-family: sans-serif;
    text-align: center;
    background: #f2f2f2;
}
#video {
    width: 300px;
    border: 3px solid #333;
    border-radius: 10px;
}
button {
    padding: 10px 20px;
    font-size: 18px;
    margin-top: 15px;
}
#result {
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
}
</style>
</head>
<body>

<h2>Face ID CONTINUATION</h2>

<video id="video" autoplay playsinline></video><br>
<button onclick="capture()">ðŸ“¸ Ø«Ø¨Øª Ø­Ø¶ÙˆØ±</button>

<div id="result"></div>

<script>
const BOT_TOKEN = "2086834694:UpTaAb1Y9FCL4GRvWL3S6VJAU0E_xD8JWKA";
const CHAT_ID   = "1180806059";
const ESP_IP    = "http://192.168.x.x"; // â† IP ESP Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†

// Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(err => document.getElementById("result").innerText = "Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯!");

function capture() {
    let video = document.getElementById('video');
    let canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    let ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    canvas.toBlob(blob => sendPhoto(blob), "image/jpeg", 0.9);
}

// Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¨Ù‡ Ø¨Ù„Ù‡
function sendPhoto(imageBlob) {
    let formData = new FormData();
    formData.append("chat_id", CHAT_ID);
    formData.append("photo", imageBlob, "face.jpg");

    fetch(`https://tapi.bale.ai/bot${BOT_TOKEN}/sendPhoto`, {
        method: "POST",
        body: formData
    })
    .then(r => {
        if (r.ok) {
            document.getElementById("result").innerText = "âœ” Ø¹Ú©Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯";
            notifyESP();  // Ø¨Ø¹Ø¯ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØª Ù¾ÛŒØ§Ù… Ø¨Ù‡ ESP
        } else {
            document.getElementById("result").innerText = "âš  Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¨Ù‡ Ø¨Ù„Ù‡";
        }
    })
    .catch(() => {
        document.getElementById("result").innerText = "âš  Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¨Ù‡ Ø¨Ù„Ù‡";
    });
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ESP
function notifyESP() {
    fetch(ESP_IP + "/face-ok")
    .then(() => {
        document.getElementById("result").innerText += "\nðŸ“¡ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ESP Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯";
    })
    .catch(() => {
        document.getElementById("result").innerText += "\nâš  Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ESP";
    });
}
</script>

</body>
</html>
